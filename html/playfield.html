<html>
<head>
	<title>Playfield</title>
	<script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect('/playfield');
		var theBoard = {};
		var numberOfPlayers = 0;
		var numberOfCalls = 0;

		var times = 0;
		var totalTime = 0;

        // initialize a new board
		socket.on('players', function (players) {
			theBoard = {};
			numberOfPlayers = 0;
			for (p in players) {
				theBoard[players[p].id] = {};
				if (players[p].username) theBoard[players[p].id].username = players[p].username;
				theBoard[players[p].id].x = 100;
				theBoard[players[p].id].y = numberOfPlayers;
				numberOfPlayers++;
			}
			updateBoard();
        });

        socket.on('updates', function (updates) {
			// record the change for stats
			numberOfCalls += updates.length;

// start a timer
var start = new Date().getTime();

			// process the player move			
			for (update in updates) {
				data = updates[update];
				if (theBoard[data.id]) { // boundary condition on playfield restart
					if (data.dir == "l") {
						theBoard[data.id].x -= 10;
					} else {
						theBoard[data.id].x += 10;
					}
				}
			}

			updateBoard();

// end timer
var end = new Date().getTime();
totalTime += end - start;
times ++;

        });

		// user changed their name
		// Sometimes the player with data.id is not found. Not sure why!
        socket.on('namechange', function (data) {
			theBoard[data.id].username = data.username;
			updateBoard();
		});

        socket.on('newuser', function (data) {
			theBoard[data.id] = {};
			theBoard[data.id].x = 100;
			theBoard[data.id].y = numberOfPlayers;
			numberOfPlayers++;

			updateBoard();
        });

		// Color them out on woosing out of the game
        socket.on('woosout', function (data) {
			theBoard[data.id].dead = true;
			updateBoard();
		});

		function updateBoard() {
			var c=document.getElementById("playfield");
			var ctx=c.getContext("2d");

			ctx.clearRect (0,0,600,200);
			for (p in theBoard) {
				x = theBoard[p].x;
				y = theBoard[p].y;
				if (!theBoard[p].dead ) { 
					ctx.fillStyle="#33CCff"; 
				} else { 
					ctx.fillStyle="#113311"; // black
				}
				ctx.fillRect(x-5,y*10+2,x+5,y*10+8);

				if (theBoard[p].username) {
					ctx.fillStyle="#ff1144"; 
					ctx.font = "bold 15px arial";     // different font
					ctx.fillText(theBoard[p].username, x, y*10 + 10);
				}
			}	
		}

		// every second see how many user updates were received		
		var lastCount = 0;
		function stats() {
			callsInThisPeriod = numberOfCalls - lastCount;
			document.getElementById("stats").innerHTML = callsInThisPeriod;
			lastCount = numberOfCalls;

			document.getElementById("timer").innerHTML = totalTime/times;
			totalTime=0;times=0;

			setTimeout(stats, 1000);
		}
	
    </script>
</head>

<body bgcolor="lightblue">
<h1> Mass Mobile Hallucinegenic Playfield <h1>
<div style="background-color: grey">
	Messages per second: <span id="stats"></span></br>
	Time to process a packet: <span id="timer">f</span>
</div>

<canvas id="playfield" width="900" height="400" bgcolor="gold"></canvas>
<div style="width: 100%; background-color: pink">THE END</div>
<script>
	stats();
</script>
</body>
</html>
