<!DOCTYPE HTML>
<html>
    <head>
        <title>Mass Mobile Hallucination</title>
        <script src="/socket.io/socket.io.js"></script>
        <script src="mmh.js"></script>
        <script src="mousemotioncontrol.js" type="text/javascript"></script>
        <link rel="stylesheet" href="style.css" type="text/css"/>
    </head>
    <body>
        <div id="main" class="fullscreen">
            <h1>The Mass Mobie Hallucination Game.</h1>Your name:
            <input type=text onchange="changeName()"
            id=username />
            <br/>
            <span>
                <input type=button class=bigbutton value="LEFT"/>
                <input type=button class=bigbutton value="RIGHT"/>
            </span>
            <div id="log"></div>
        </div>
        
        <div id="color" style="display:none">
            <script type="text/javascript">
                function drawValues() {
                    accel = MMH.getOrientation();
                    document.getElementById("doTiltLR").innerHTML = Math.round(accel.tiltLR);
                }
            </script>
            <div style="background-color: hotpink; height: 100%; width: 100%">COLOR HERE.</div>
        </div>
        <div id="brickout" style="display: none">
            <div style="background-color: lime; height: 100%; width: 100%">
                <h1>The brickout game</h1>Most of these games will actually have the same
                controller. So it won't change anything...</div>
        </div>
        <div id="tilt" style="display: none">
            <div style="background-color: gold; height: 100%; width: 100%;">BASIC TILT SCREEN. Used for a number of games. (should there be a ball
                rolling around) or something else to indicate that we are interested in
                your tilt. Maybe... sometimes mystery is better.
            
                <div id="mousecontroller" style="display:block"> <p>No accelerometer detected use the mouse instead. Click canvas to start
                and stop. Move mouse to rotate arrow.
					<canvas id="mousecanvas" width=200 height=200 style="display:block"></canvas>
					<div id="arrowlog"></div>
				</div>
			</div>
		</div>
        <div id="redgreen" style="display: none">
            <div style="background-color: green; height: 100%; width: 50%; float: right"></div>
            <div style="background-color: red; height: 100%; width: 50%; float: left"></div>
        </div>
        <script>
            // What game controllers this file supports. The <div> to show and
            // any initialization function to call to get it going.
            var gameConfig = {}
            gameConfig.worm 	= {section: "redgreen", func: initTilt};
            gameConfig.color 	= {section: "color", func: initColor };
            gameConfig.fairy 	= {section: "tilt", func: initTilt};
            gameConfig.bounce 	= {section: "tilt", func: initTilt};
            gameConfig.brickout = {section: "redgreen",func: initRedGreen};


            var socket = io.connect('/players');

            socket.on('changeSettings', function (data) {
                document.getElementById("log").innerHTML = "message from controller " + JSON.stringify(data);
            });

            socket.on('changeGame', function (game) {
                changeGame(game);
            });

            // // display mouse arrow (used when no acceleromters present)
            // function initmousedetection() {
		
            //         $("#mousecontroller").css('display', 'block');
            //         var mouseArrow = new MouseArrow();
            //         mouseArrow.init("mousecanvas");
          
          
            //         //send mouse movements to MMH to be processed
            //         mouseArrow.subscribeorientationchanged(MMH.sendMovement);
            //         // Timer for animation.
            //         setInterval(function () {
            //             mouseArrow.updatePosition();
            //             mouseArrow.drawArrow();
            //             var angle = mouseArrow.angle();
            //             var orientation = mouseArrow.getOrientation();
            //             $("#arrowlog").html(' tiltLR: ' + orientation.tiltLR + ' tiltFB: ' + orientation.tiltFB);
            //         }, 20);
         
            // }

            // Change the game on request of the controller and initialize the screens and data
            function changeGame(gameName) {
                // Change the screen and call ainitialization routine;
                var section = gameConfig[gameName].section;
                var initFunction = gameConfig[gameName].func;

                // change in the new section content
                document.getElementById("main").innerHTML = document.getElementById(section).innerHTML;

                // call the init function (as specified)
                initFunction();
            }

			// TODO move to MMH.js
            function changeName() {
                socket.emit("namechange", document.getElementById('username').value);
            }

			function movementCallback (accel) {
				mouseArrow.updatePosition(accel.tiltLR, accel.tiltFB);
				mouseArrow.drawArrow();
			}
			
            function initTilt() {
                // start the acceleromters sending
				MMH.init(socket);
				//if (!MMH.clientHasAcceleromters()) {
				//	initmousedetection();
				//}
				mouseArrow = new MouseArrow();
				mouseArrow.init("mousecanvas");
				MMH.listenForMovements(movementCallback);
				
            }

            function initColor() {
                // start the acceleromters sending
                MMH.init(socket);
				MMH.listenForMovements();
            }

            function initRedGreen() {
                // ask the server what color we are and set the background accordingly.
            }
        </script>
    </body>
</html>