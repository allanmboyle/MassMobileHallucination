<html>
<head>
	<title>Playfield</title>
	<script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io.connect('http://localhost/playfield');
		var theBoard = {};
		var numberOfPlayers = 0;

        // initialize a new board
		socket.on('players', function (players) {
			theBoard = {};
			numberOfPlayers = 0;
			for (p in players) {
				theBoard[players[p].id] = {};
				if (players[p].username) theBoard[players[p].id].username = players[p].username;
				theBoard[players[p].id].x = 100;
				theBoard[players[p].id].y = numberOfPlayers;
				numberOfPlayers++;
			}
        });

        socket.on('change', function (data) {
			if (theBoard[data.id]) { // boundary condition on playfield restart
				if (data.direction == "left") {
					theBoard[data.id].x -= 10;
				} else {
					theBoard[data.id].x += 10;
				}
			}

			updateBoard();
        });

		// user changed their name
		// Sometimes the player with data.id is not found. Not sure why!
        socket.on('namechange', function (data) {
			theBoard[data.id].username = data.username;
		});

        socket.on('newuser', function (data) {
			theBoard[data.id] = {};
			theBoard[data.id].x = 100;
			theBoard[data.id].y = numberOfPlayers;
			numberOfPlayers++;

			updateBoard();
        });

		// Color them out on woosing out of the game
        socket.on('woosout', function (data) {
			theBoard[data.id].dead = true;
		});

		function updateBoard() {
			var c=document.getElementById("playfield");
			var ctx=c.getContext("2d");

			ctx.clearRect (0,0,200,100);
			for (p in theBoard) {
				x = theBoard[p].x;
				y = theBoard[p].y;
				if (!theBoard[p].dead ) { 
					ctx.fillStyle="#33CCff"; 
				} else { 
					ctx.fillStyle="#113311"; // black
				}
				ctx.fillRect(x-5,y*10+2,x+5,y*10+8);
			}	
		}
    </script>
</head>

<body bgcolor="lightblue">
<h1> Mass Mobile Hellucinegenic Playfield <h1>
<canvas id="playfield" width="200" height="100" bgcolor="gold"></canvas>
</body>
</html>
